-- Prepared by Vinay(vinay.nagaraj@enhancesys.com)

-- delete old ppk path, Query Field, Dump Date Count (if exists)
DELETE FROM INTERFACE.MS_INTERFACE_ATTR WHERE ATTRIBUTE_ID_N IN (1184030, 1184031, 1184032);

-- Query Field for 1184
INSERT INTO INTERFACE.MS_INTERFACE_ATTR (ATTRIBUTE_ID_N, INTERFACE_ID_N, NAME_V, VALUE_V, LAST_UPDATED_TIME_DT) VALUES (1184030, 1184, 'Query Field', 'DumpDate', now());

-- Dump Date Count for 1184
INSERT INTO INTERFACE.MS_INTERFACE_ATTR (ATTRIBUTE_ID_N, INTERFACE_ID_N, NAME_V, VALUE_V, LAST_UPDATED_TIME_DT) VALUES (1184031, 1184, 'Dump Date Count', '0', now());

-- PPK Path for 1184 (testing)
--INSERT INTO INTERFACE.MS_INTERFACE_ATTR (ATTRIBUTE_ID_N, INTERFACE_ID_N, NAME_V, VALUE_V, LAST_UPDATED_TIME_DT) VALUES (1184032, 1184, 'PPK Path', '/home/appuser/snoc/snocconf/interfaceconf/credentials/TEST_251.ppk', NOW());

-- Pg Query for 1184
update interface.ms_interface_attr set value_v = 'SELECT channel_category_v  AS channel_category , regional_v  AS regional , area_v  AS area , sales_area_v  AS sale_sarea , cluster_v AS cluster  , micro_cluster_v AS micro_cluster  , sale_territory_v  AS sale_territory , territory_id_v  AS territory_id , org_id_n  AS outlet_id  , outlet_ref_code_v AS outlet_ref_code  , outlet_name_v AS outlet_name  , cso_name_v  AS cso_name , cso_operator_id_v AS cso_operator_id  , cso_org_id_n  AS cso_org_id , cso_org_ref_code_v  AS cso_org_ref_code , cso_org_name_v  AS cso_org_name , prd_ctgr_id_n AS product_category_id  , prd_ctgr_name_v AS product_category_name  , threshold_n AS threshold_value  , stock_value_n AS available_stock  , stock_days_n  AS stock_days , percentage_n  AS stock_percentage , sales_flag_bl AS prev_month_sales , prev_month_sales_n  AS prev_month_sales_value , transaction_days_n  AS prev_month_transaction_days, inc_by_percent_n  AS increase_by_percentage , prev_sellin_n AS prev_day_sellin  , prev_suggestion_n AS prev_day_suggestion  , rem_suggestion_n  AS remaining_suggestion , actual_suggestion_n AS actual_suggestion  , pjp_status_v  AS today_pjp FROM kpi.tr_stock_reorder_aggr WHERE day_id_n = (select to_char(''DumpDate''::timestamp,''yyyymmdd'')::numeric)  UNION  SELECT channel_category_v  AS channel_category , regional_v  AS regional , area_v  AS area , sales_area_v  AS sale_sarea , cluster_v AS cluster  , micro_cluster_v AS micro_cluster  , sale_territory_v  AS sale_territory , territory_id_v  AS territory_id , org_id_n  AS outlet_id  , outlet_ref_code_v AS outlet_ref_code  , outlet_name_v AS outlet_name  , cso_name_v  AS cso_name , cso_operator_id_v AS cso_operator_id  , cso_org_id_n  AS cso_org_id , cso_org_ref_code_v  AS cso_org_ref_code , cso_org_name_v  AS cso_org_name , prd_ctgr_id_n AS product_category_id  , prd_ctgr_name_v AS product_category_name  , threshold_n AS threshold_value  , stock_value_n AS available_stock  , stock_days_n  AS stock_days , percentage_n  AS stock_percentage , sales_flag_bl AS prev_month_sales , prev_month_sales_n  AS prev_month_sales_value , transaction_days_n  AS prev_month_transaction_days, inc_by_percent_n  AS increase_by_percentage , prev_sellin_n AS prev_day_sellin  , prev_suggestion_n AS prev_day_suggestion  , rem_suggestion_n  AS remaining_suggestion , actual_suggestion_n AS actual_suggestion  , pjp_status_v  AS today_pjp FROM kpi.tr_stock_suggest_aggr WHERE day_id_n = (select to_char(''DumpDate''::timestamp,''yyyymmdd'')::numeric);' where attribute_id_n = 1184029;

-- 1094_SOM_Summary_Territory
update interface.ms_interface_attr set value_v = 'select ''1094_SOM_Summary_Territory'' as report_name, report_org_master.channel_category_v as channel, report_org_master.region_v as region, report_org_master.area_v as area, report_org_master.sales_area_v as salesarea, report_org_master.cluster_v as cluster, report_org_master.micro_cluster_v as microcluster, null as additionalterritory, report_org_master.org_short_code_v as territoryid, report_product_master.product_name_v as productbrand, report_product_master.product_type_n as producttype, report_product_master.product_category_name_v as productcategory, report_product_master.product_id_n::text as productid, report_product_master.product_code_v as productextid, report_product_master.product_name_v as productname, coalesce(sum(stock_ledger_aggr.closing_stock_qty_n),0) as qty, coalesce((case when coalesce((sum(stock_ledger_aggr.stock_in_qty_n) - sum(stock_ledger_aggr.stock_out_qty_n)),0) > 0 then round(((sum(stock_ledger_aggr.stock_in_qty_n) - sum(stock_ledger_aggr.stock_out_qty_n))/7),0) else 0 end),0) as averageqty, coalesce((case when (coalesce((sum(stock_ledger_aggr.stock_in_qty_n) - sum(stock_ledger_aggr.stock_out_qty_n)),0) > 0 and round(((sum(stock_ledger_aggr.stock_in_qty_n) - sum(stock_ledger_aggr.stock_out_qty_n))/7),0) > 0) then round((sum(stock_ledger_aggr.closing_stock_qty_n)/round(((sum(stock_ledger_aggr.stock_in_qty_n) - sum(stock_ledger_aggr.stock_out_qty_n))/7),0)),0) else 0 end),0) as businessdays from (select 	daily_stock_ledger.org_id_n as org_id_n, daily_stock_ledger.metrics_id_n, coalesce(sum(daily_stock_ledger.closing_stock_qty_n),0) as closing_stock_qty_n, coalesce(sum(average_stock_ledger.stock_in_qty_n),0) as stock_in_qty_n, coalesce(sum(average_stock_ledger.stock_out_qty_n),0) as stock_out_qty_n from	 	(select 		org_id_n as org_id_n, metrics_id_n as metrics_id_n, sum(closing_stock_qty_n) as closing_stock_qty_n 	from	 		kpi.tr_daily_stock_ledger 	where 		day_id_n = (select to_char((select date ''yesterday''),''yyyymmdd'')::numeric) 	group by 		org_id_n, metrics_id_n 	) as daily_stock_ledger 	left join lateral 	(select 		org_id_n as org_id_n, metrics_id_n as metrics_id_n, sum(stock_in_qty_n) as stock_in_qty_n, sum(stock_out_qty_n) as stock_out_qty_n 	from 		kpi.tr_daily_stock_ledger 	where 		day_id_n between (select to_char(((select date ''yesterday'') - interval ''6 days''),''yyyymmdd'')::numeric) and (select to_char((select date ''yesterday''),''yyyymmdd'')::numeric) 	group by 		org_id_n, metrics_id_n 	) average_stock_ledger on (average_stock_ledger.org_id_n = daily_stock_ledger.org_id_n and average_stock_ledger.metrics_id_n = daily_stock_ledger.metrics_id_n) group by 	daily_stock_ledger.org_id_n, daily_stock_ledger.metrics_id_n ) as stock_ledger_aggr inner join kpi.ms_report_org_master as report_org_master on (report_org_master.org_id_n = stock_ledger_aggr.org_id_n) inner join kpi.ms_report_product_master as report_product_master on (report_product_master.product_id_n = stock_ledger_aggr.metrics_id_n) group by channel, region, area, salesarea, cluster, microcluster, additionalterritory, territoryid, producttype, productbrand, productcategory, productname, productid, productextid;' where attribute_id_n = 1094029;

-- 1106_SOM_Summary_Organization_Wise
update interface.ms_interface_attr set value_v = 'select ''1106_SOM_Summary_Organization_Wise'' as report_name, report_org_master.channel_category_v as channel, report_org_master.region_v as region, report_org_master.area_v as area, report_org_master.sales_area_v as salesarea, report_org_master.cluster_v as cluster, report_org_master.micro_cluster_v as microcluster, null as additionalterritory, report_org_master.org_short_code_v as territoryid, report_org_master.sub_org_type_name_v as suborgtype, report_org_master.org_id_n::text as organizationid, report_org_master.org_short_code_v as orgshortcode, report_org_master.org_name_v as organizationname, report_product_master.product_name_v as productbrand, report_product_master.product_type_n as producttype, report_product_master.product_category_name_v as productcategory, report_product_master.product_id_n::text as productid, report_product_master.product_code_v as productextid, report_product_master.product_name_v as productname, coalesce(sum(stock_ledger_aggr.closing_stock_qty_n),0) as qty, coalesce((case when coalesce((sum(stock_ledger_aggr.stock_in_qty_n) - sum(stock_ledger_aggr.stock_out_qty_n)),0) > 0 then round(((sum(stock_ledger_aggr.stock_in_qty_n) - sum(stock_ledger_aggr.stock_out_qty_n))/7),0) else 0 end),0) as averageqty, coalesce((case when (coalesce((sum(stock_ledger_aggr.stock_in_qty_n) - sum(stock_ledger_aggr.stock_out_qty_n)),0) > 0 and round(((sum(stock_ledger_aggr.stock_in_qty_n) - sum(stock_ledger_aggr.stock_out_qty_n))/7),0) > 0) then round((sum(stock_ledger_aggr.closing_stock_qty_n)/round(((sum(stock_ledger_aggr.stock_in_qty_n) - sum(stock_ledger_aggr.stock_out_qty_n))/7),0)),0) else 0 end),0) as businessdays from (select 	daily_stock_ledger.org_id_n as org_id_n, daily_stock_ledger.metrics_id_n, coalesce(sum(daily_stock_ledger.closing_stock_qty_n),0) as closing_stock_qty_n, coalesce(sum(average_stock_ledger.stock_in_qty_n),0) as stock_in_qty_n, coalesce(sum(average_stock_ledger.stock_out_qty_n),0) as stock_out_qty_n from	 	(select 		org_id_n as org_id_n, metrics_id_n as metrics_id_n, sum(closing_stock_qty_n) as closing_stock_qty_n 	from	 		kpi.tr_daily_stock_ledger 	where 		day_id_n = (select to_char((select date ''yesterday''),''yyyymmdd''::text)::numeric) 	group by 		org_id_n, metrics_id_n 	) as daily_stock_ledger 	left join lateral 	(select 		org_id_n as org_id_n, metrics_id_n as metrics_id_n, sum(stock_in_qty_n) as stock_in_qty_n, sum(stock_out_qty_n) as stock_out_qty_n 	from 		kpi.tr_daily_stock_ledger 	where 		day_id_n between (select to_char(((select date ''yesterday'') - interval ''6 days''),''yyyymmdd'')::numeric) and (select to_char((select date ''yesterday''),''yyyymmdd''::text)::numeric) 	group by 		org_id_n, metrics_id_n 	) average_stock_ledger on (average_stock_ledger.org_id_n = daily_stock_ledger.org_id_n and average_stock_ledger.metrics_id_n = daily_stock_ledger.metrics_id_n) group by 	daily_stock_ledger.org_id_n, daily_stock_ledger.metrics_id_n ) as stock_ledger_aggr inner join kpi.ms_report_org_master as report_org_master on (report_org_master.org_id_n = stock_ledger_aggr.org_id_n) inner join kpi.ms_report_product_master as report_product_master on (report_product_master.product_id_n = stock_ledger_aggr.metrics_id_n) group by channel, region, area, salesarea, cluster, microcluster, additionalterritory, territoryid, suborgtype, organizationid, orgshortcode, organizationname,productbrand,producttype, productcategory, productname, productid,productextid;' where attribute_id_n = 1106029;

